{% extends 'base.html' %}

{% block title %}Dashboard - VBMonitor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <h5><i class="bi bi-newspaper"></i> Total Notícias</h5>
            <h2>{{ total_noticias }}</h2>
            <small>Últimos 30 dias</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success">
            <h5><i class="bi bi-link"></i> Fontes Ativas</h5>
            <h2>{{ fontes_ativas }}</h2>
            <small>Monitoradas</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <h5><i class="bi bi-eye"></i> Acessos Hoje</h5>
            <h2>{{ acessos_hoje }}</h2>
            <small>Notícias visualizadas</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card danger">
            <h5><i class="bi bi-bell"></i> Alertas Ativos</h5>
            <h2>{{ alertas_ativos }}</h2>
            <small>Configurados</small>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-trending-up"></i> Notícias em Alta</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Fonte</th>
                                <th>Acessos</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for noticia in noticias_em_alta %}
                            <tr>
                                <td>
                                    <a href="{% url 'detalhe_noticia' noticia.id %}" class="text-decoration-none">
                                        {{ noticia.titulo|truncatechars:60 }}
                                    </a>
                                </td>
                                <td>{{ noticia.fonte.nome }}</td>
                                <td><span class="badge bg-primary">{{ noticia.acessos }}</span></td>
                                <td>{{ noticia.data_publicacao|date:"d/m/Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">Nenhuma notícia disponível</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-pie-chart"></i> Distribuição por Pauta</h5>
            </div>
            <div class="card-body">
                <canvas id="pautasChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar"></i> Atividade Recente</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for atividade in atividades_recentes %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">{{ atividade.data|date:"d/m H:i" }}</small><br>
                            {{ atividade.descricao }}
                        </div>
                        <span class="badge bg-{{ atividade.tipo }}">{{ atividade.badge }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center">Nenhuma atividade recente</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-lightning-charge"></i> Ações Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <a href="{% url 'admin:core_noticia_add' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-plus-circle"></i> Nova Notícia
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="{% url 'admin:core_fonte_add' %}" class="btn btn-outline-success w-100 mb-2">
                            <i class="bi bi-link"></i> Nova Fonte
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="/admin/" class="btn btn-outline-warning w-100 mb-2">
                            <i class="bi bi-bell"></i> Painel Admin
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="/api/core/noticias/" class="btn btn-outline-info w-100 mb-2">
                            <i class="bi bi-code-slash"></i> API Notícias
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JSON seguro para o JavaScript -->
{{ pautas_labels|json_script:"pautas-labels" }}
{{ pautas_data|json_script:"pautas-data" }}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const canvas = document.getElementById('pautasChart');
    if (!canvas) return;

    const labels = JSON.parse(
        document.getElementById('pautas-labels').textContent
    );
    const data = JSON.parse(
        document.getElementById('pautas-data').textContent
    );

    new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
</script>
{% endblock %}
